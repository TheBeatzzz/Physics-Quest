import React, { useState, useEffect, useRef } from 'react';

// --- INITIAL PHYSICS CONSTANTS ---
const STANDARD_CONSTANTS = {
  name: "Standard-Brane",
  G: 6.67,
  c: 299, // Simplified for math
  h: 6.62,
  uncertainty: 0.1
};

const WILD_POOL = [
  { name: "Electron", type: "Static", hp: 50, maxHp: 50, freq: 10 },
  { name: "Probability Ghost", type: "Quantum", hp: 40, maxHp: 40, freq: 25 },
  { name: "Dark Matter Mote", type: "Dark", hp: 100, maxHp: 100, freq: 5 }
];

export default function KineticQuestFull() {
  // --- GAME STATE ---
  const [universe, setUniverse] = useState(STANDARD_CONSTANTS);
  const [player, setPlayer] = useState({ name: "Photiny", hp: 100, maxHp: 100, freq: 15 });
  const [enemy, setEnemy] = useState(WILD_POOL[0]);
  const [log, setLog] = useState("System Online. Constants calibrated to Standard-Brane.");
  const [isBattleOver, setIsBattleOver] = useState(false);
  const [isShaking, setIsShaking] = useState(false);

  // --- AUDIO SYNTHESIZER ---
  const playTone = (freq, duration, type = 'sine') => {
    try {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + duration);
    } catch (e) { console.log("Audio blocked by browser."); }
  };

  // --- MULTIVERSE GENERATOR ---
  const shiftUniverse = () => {
    const prefixes = ["Neon", "Hyper-Dense", "Superfluid", "Void"];
    const newH = (Math.random() * 50).toFixed(2);
    const newUniverse = {
      name: `${prefixes[Math.floor(Math.random() * prefixes.length)]}-Dimension`,
      G: (Math.random() * 20).toFixed(2),
      c: (Math.random() * 500).toFixed(0),
      h: newH,
      uncertainty: newH / 100
    };
    setUniverse(newUniverse);
    setLog(`TUNNELING SUCCESSFUL. Welcome to ${newUniverse.name}. h is now ${newUniverse.h}!`);
    resetEncounter();
  };

  // --- BATTLE ENGINE ---
  const handleAttack = (moveName, power, type) => {
    if (isBattleOver) return;

    // High-h Uncertainty Logic
    const missRoll = Math.random();
    if (missRoll < universe.uncertainty) {
      setLog(`The Wave Function collapsed! ${moveName} missed due to uncertainty.`);
      playTone(100, 0.2, 'sawtooth');
      setTimeout(enemyTurn, 1000);
      return;
    }

    // Damage Formula: E = h * f
    const baseDmg = (universe.h * player.freq) / 10 + power;
    const finalDmg = Math.floor(baseDmg);

    setIsShaking(true);
    playTone(440 + (player.freq * 10), 0.1, 'sine');
    
    setEnemy(prev => {
      const newHp = Math.max(0, prev.hp - finalDmg);
      if (newHp === 0) setIsBattleOver(true);
      return { ...prev, hp: newHp };
    });

    setLog(`Photiny used ${moveName}! Dealt ${finalDmg} energy decay.`);
    
    if (enemy.hp - finalDmg > 0) {
      setTimeout(() => {
        setIsShaking(false);
        enemyTurn();
      }, 1000);
    } else {
      setLog(`Target Annihilated. Experiment complete.`);
    }
  };

  const enemyTurn = () => {
    if (isBattleOver) return;
    const dmg = Math.floor(enemy.freq * (universe.G / 5));
    setPlayer(p => ({ ...p, hp: Math.max(0, p.hp - dmg) }));
    setLog(`${enemy.name} emitted radiation! Dealt ${dmg} damage.`);
    playTone(150, 0.3, 'triangle');
  };

  const resetEncounter = () => {
    const next = WILD_POOL[Math.floor(Math.random() * WILD_POOL.length)];
    setEnemy({ ...next, hp: next.maxHp });
    setPlayer(p => ({ ...p, hp: p.maxHp }));
    setIsBattleOver(false);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-cyan-400 p-6 font-mono flex flex-col items-center">
      {/* HUD: Universe Constants */}
      <div className="w-full max-w-2xl bg-slate-900 border border-cyan-800 p-4 rounded-t-lg flex justify-between text-[10px] uppercase tracking-widest">
        <div>Dimension: <span className="text-white">{universe.name}</span></div>
        <div>h: {universe.h}</div>
        <div>c: {universe.c}</div>
        <div>G: {universe.G}</div>
      </div>

      {/* Battle Screen */}
      <div className={`w-full max-w-2xl bg-black border-x-2 border-cyan-900 p-8 flex flex-col items-center relative overflow-hidden ${isShaking ? 'animate-bounce' : ''}`}>
        {/* Enemy */}
        <div className="mb-12 text-center">
          <div className="w-24 h-24 bg-gradient-to-t from-purple-900 to-transparent rounded-full blur-xl absolute opacity-50"></div>
          <h2 className="text-xl font-bold text-red-500 mb-2">{enemy.name}</h2>
          <div className="w-48 bg-gray-800 h-2 rounded-full overflow-hidden">
            <div className="bg-red-600 h-full transition-all duration-500" style={{width: `${(enemy.hp/enemy.maxHp)*100}%`}}></div>
          </div>
        </div>

        {/* Player */}
        <div className="mt-12 text-center self-start ml-10">
          <h2 className="text-lg font-bold text-cyan-400 uppercase tracking-tighter">Unit: {player.name}</h2>
          <div className="w-40 bg-gray-800 h-2 rounded-full overflow-hidden">
            <div className="bg-cyan-500 h-full transition-all duration-500" style={{width: `${(player.hp/player.maxHp)*100}%`}}></div>
          </div>
        </div>
      </div>

      {/* Terminal Log */}
      <div className="w-full max-w-2xl bg-slate-900 border-x-2 border-b-2 border-cyan-900 p-4 h-24 overflow-y-auto text-sm italic border-t border-t-slate-800">
        <span className="text-cyan-700 mr-2">{">"}</span> {log}
      </div>

      {/* Control Panel */}
      <div className="grid grid-cols-2 gap-4 mt-6 w-full max-w-2xl">
        <button 
          onClick={() => handleAttack("Optical Pulse", 10, "Optical")}
          className="p-4 bg-cyan-950 hover:bg-cyan-800 border border-cyan-500 text-cyan-400 font-bold rounded active:scale-95 transition-all"
        >
          OPTICAL PULSE
        </button>
        <button 
          onClick={() => handleAttack("Quantum Tunnel", 25, "Quantum")}
          className="p-4 bg-purple-950 hover:bg-purple-800 border border-purple-500 text-purple-400 font-bold rounded active:scale-95 transition-all"
        >
          QUANTUM TUNNEL
        </button>
        <button 
          onClick={shiftUniverse}
          className="p-4 bg-amber-950 hover:bg-amber-800 border border-amber-500 text-amber-400 font-bold rounded col-span-2"
        >
          INITIATE MULTIVERSE JUMP
        </button>
      </div>

      <p className="mt-8 text-[10px] opacity-40">KINETIC-QUEST v1.0 // OBSERVATIONAL DATA ONLY</p>
    </div>
  );
}
